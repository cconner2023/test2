<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PackageBackEnd - Database Setup</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #0f172a; color: #e2e8f0; padding: 2rem; line-height: 1.6; }
  .container { max-width: 900px; margin: 0 auto; }
  h1 { color: #38bdf8; margin-bottom: 0.5rem; font-size: 1.8rem; }
  h2 { color: #94a3b8; margin: 2rem 0 1rem; font-size: 1.3rem; }
  .subtitle { color: #64748b; margin-bottom: 2rem; }
  .step { background: #1e293b; border: 1px solid #334155; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem; }
  .step-header { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; }
  .step-num { background: #38bdf8; color: #0f172a; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0; }
  .step-title { font-weight: 600; font-size: 1.1rem; }
  .sql-box { background: #0f172a; border: 1px solid #475569; border-radius: 8px; padding: 1rem; max-height: 300px; overflow: auto; font-family: 'Fira Code', 'Consolas', monospace; font-size: 0.8rem; white-space: pre-wrap; word-break: break-all; color: #a5f3fc; margin: 1rem 0; }
  button { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.95rem; transition: all 0.2s; }
  .btn-primary { background: #38bdf8; color: #0f172a; }
  .btn-primary:hover { background: #7dd3fc; }
  .btn-secondary { background: #334155; color: #e2e8f0; }
  .btn-secondary:hover { background: #475569; }
  .btn-success { background: #22c55e; color: #0f172a; }
  .btn-success:hover { background: #4ade80; }
  .btn-group { display: flex; gap: 0.75rem; flex-wrap: wrap; }
  a { color: #38bdf8; }
  .status { padding: 1rem; border-radius: 8px; margin: 1rem 0; }
  .status-ok { background: #064e3b; border: 1px solid #059669; color: #6ee7b7; }
  .status-err { background: #450a0a; border: 1px solid #dc2626; color: #fca5a5; }
  .status-warn { background: #422006; border: 1px solid #d97706; color: #fde68a; }
  .status-info { background: #0c4a6e; border: 1px solid #0284c7; color: #7dd3fc; }
  .table-grid { display: grid; gap: 0.5rem; margin: 1rem 0; }
  .table-row { display: flex; align-items: center; gap: 0.75rem; padding: 0.5rem 1rem; background: #0f172a; border-radius: 6px; }
  .table-icon { font-size: 1.2rem; }
  .table-name { font-family: monospace; font-weight: 600; }
  .table-status { margin-left: auto; font-size: 0.85rem; }
  #verify-results { display: none; }
  .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid #64748b; border-top-color: #38bdf8; border-radius: 50%; animation: spin 0.6s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }
  .hidden { display: none; }
</style>
</head>
<body>
<div class="container">
  <h1>PackageBackEnd Database Setup</h1>
  <p class="subtitle">Apply the database schema to your Supabase project</p>

  <!-- Step 1: Open SQL Editor -->
  <div class="step">
    <div class="step-header">
      <div class="step-num">1</div>
      <div class="step-title">Open Supabase SQL Editor</div>
    </div>
    <p>Go to your Supabase project's SQL Editor:</p>
    <div class="btn-group" style="margin-top: 1rem;">
      <a href="https://supabase.com/dashboard/project/rkkyhhxcsqwyxwrpfrle/sql/new" target="_blank">
        <button class="btn-primary">Open SQL Editor &rarr;</button>
      </a>
    </div>
    <p style="margin-top: 0.75rem; color: #94a3b8; font-size: 0.9rem;">
      You'll need to sign in to the Supabase Dashboard if you haven't already.
    </p>
  </div>

  <!-- Step 2: Copy SQL -->
  <div class="step">
    <div class="step-header">
      <div class="step-num">2</div>
      <div class="step-title">Copy and Run the Migration SQL</div>
    </div>
    <p>Click the button below to copy the full migration SQL, then paste it into the SQL Editor and click "Run".</p>
    <div class="btn-group" style="margin-top: 1rem;">
      <button class="btn-primary" id="copy-btn" onclick="copySQL()">Copy Migration SQL</button>
      <button class="btn-secondary" onclick="toggleSQL()">Show/Hide SQL</button>
    </div>
    <div id="sql-preview" class="sql-box hidden"></div>
  </div>

  <!-- Step 3: Verify -->
  <div class="step">
    <div class="step-header">
      <div class="step-num">3</div>
      <div class="step-title">Verify Schema</div>
    </div>
    <p>After running the SQL, click "Verify" to check that all tables were created correctly.</p>
    <div class="btn-group" style="margin-top: 1rem;">
      <button class="btn-success" id="verify-btn" onclick="verifySchema()">Verify Schema</button>
    </div>
    <div id="verify-loading" class="hidden" style="margin-top: 1rem;">
      <span class="spinner"></span> Checking tables...
    </div>
    <div id="verify-results"></div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://rkkyhhxcsqwyxwrpfrle.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJra3loaHhjc3F3eXh3cnBmcmxlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzExNDE2MTMsImV4cCI6MjA4NjcxNzYxM30.8yQ95OMPqWHaIjpcLRw91AflRCxoTwuiyihBoboWPEk';

const MIGRATION_SQL = `-- =============================================================================
-- PackageBackEnd - Initial Database Schema
-- =============================================================================
-- Run this in your Supabase SQL Editor (https://supabase.com/dashboard/project/rkkyhhxcsqwyxwrpfrle/sql/new)
-- =============================================================================

CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- CLINICS TABLE
CREATE TABLE IF NOT EXISTS public.clinics (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  name TEXT NOT NULL,
  uic TEXT NOT NULL UNIQUE,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- PROFILES TABLE
CREATE TABLE IF NOT EXISTS public.profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  display_name TEXT,
  rank TEXT,
  uic TEXT,
  role TEXT NOT NULL DEFAULT 'medic' CHECK (role IN ('medic', 'supervisor', 'dev')),
  clinic_id UUID REFERENCES public.clinics(id) ON DELETE SET NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- NOTES TABLE
CREATE TABLE IF NOT EXISTS public.notes (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  clinic_id UUID REFERENCES public.clinics(id) ON DELETE SET NULL,
  timestamp TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  display_name TEXT,
  rank TEXT,
  uic TEXT,
  algorithm_reference TEXT,
  hpi_encoded TEXT,
  is_imported BOOLEAN NOT NULL DEFAULT FALSE,
  source_device TEXT,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  deleted_at TIMESTAMPTZ
);

CREATE INDEX IF NOT EXISTS idx_notes_user_active ON public.notes(user_id) WHERE deleted_at IS NULL;
CREATE INDEX IF NOT EXISTS idx_notes_clinic_active ON public.notes(clinic_id) WHERE deleted_at IS NULL;

-- TRAINING COMPLETIONS TABLE
CREATE TABLE IF NOT EXISTS public.training_completions (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  training_item_id TEXT NOT NULL,
  completed BOOLEAN NOT NULL DEFAULT FALSE,
  completed_at TIMESTAMPTZ,
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  UNIQUE(user_id, training_item_id)
);

-- SYNC QUEUE TABLE
CREATE TABLE IF NOT EXISTS public.sync_queue (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  user_id UUID NOT NULL REFERENCES public.profiles(id) ON DELETE CASCADE,
  action TEXT NOT NULL CHECK (action IN ('create', 'update', 'delete')),
  table_name TEXT NOT NULL,
  record_id UUID NOT NULL,
  payload JSONB NOT NULL DEFAULT '{}',
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  synced_at TIMESTAMPTZ,
  status TEXT NOT NULL DEFAULT 'pending' CHECK (status IN ('pending', 'synced', 'failed'))
);

CREATE INDEX IF NOT EXISTS idx_sync_queue_pending ON public.sync_queue(user_id, status) WHERE status = 'pending';

-- UPDATED_AT TRIGGER
CREATE OR REPLACE FUNCTION public.update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
  NEW.updated_at = NOW();
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_profiles_updated_at') THEN
    CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON public.profiles FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_clinics_updated_at') THEN
    CREATE TRIGGER update_clinics_updated_at BEFORE UPDATE ON public.clinics FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_notes_updated_at') THEN
    CREATE TRIGGER update_notes_updated_at BEFORE UPDATE ON public.notes FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'update_training_completions_updated_at') THEN
    CREATE TRIGGER update_training_completions_updated_at BEFORE UPDATE ON public.training_completions FOR EACH ROW EXECUTE FUNCTION public.update_updated_at_column();
  END IF;
END $$;

-- AUTO-CREATE PROFILE ON AUTH SIGNUP
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.profiles (id, role, created_at, updated_at)
  VALUES (NEW.id, 'medic', NOW(), NOW());
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_trigger WHERE tgname = 'on_auth_user_created') THEN
    CREATE TRIGGER on_auth_user_created AFTER INSERT ON auth.users FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();
  END IF;
END $$;

-- ROW LEVEL SECURITY
ALTER TABLE public.profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.clinics ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.notes ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.training_completions ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.sync_queue ENABLE ROW LEVEL SECURITY;

-- PROFILES RLS
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can read own profile' AND tablename = 'profiles') THEN
    CREATE POLICY "Users can read own profile" ON public.profiles FOR SELECT USING (auth.uid() = id);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can update own profile' AND tablename = 'profiles') THEN
    CREATE POLICY "Users can update own profile" ON public.profiles FOR UPDATE USING (auth.uid() = id) WITH CHECK (auth.uid() = id);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Supervisors can read clinic profiles' AND tablename = 'profiles') THEN
    CREATE POLICY "Supervisors can read clinic profiles" ON public.profiles FOR SELECT USING (EXISTS (SELECT 1 FROM public.profiles AS p WHERE p.id = auth.uid() AND p.role IN ('supervisor', 'dev') AND p.clinic_id IS NOT NULL AND p.clinic_id = public.profiles.clinic_id));
  END IF;
END $$;

-- CLINICS RLS
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Authenticated users can read clinics' AND tablename = 'clinics') THEN
    CREATE POLICY "Authenticated users can read clinics" ON public.clinics FOR SELECT USING (auth.role() = 'authenticated');
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Dev can manage clinics' AND tablename = 'clinics') THEN
    CREATE POLICY "Dev can manage clinics" ON public.clinics FOR ALL USING (EXISTS (SELECT 1 FROM public.profiles WHERE profiles.id = auth.uid() AND profiles.role = 'dev'));
  END IF;
END $$;

-- NOTES RLS
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can read own notes' AND tablename = 'notes') THEN
    CREATE POLICY "Users can read own notes" ON public.notes FOR SELECT USING (auth.uid() = user_id AND deleted_at IS NULL);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can read clinic notes' AND tablename = 'notes') THEN
    CREATE POLICY "Users can read clinic notes" ON public.notes FOR SELECT USING (deleted_at IS NULL AND clinic_id IS NOT NULL AND EXISTS (SELECT 1 FROM public.profiles WHERE profiles.id = auth.uid() AND profiles.clinic_id = notes.clinic_id));
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can create own notes' AND tablename = 'notes') THEN
    CREATE POLICY "Users can create own notes" ON public.notes FOR INSERT WITH CHECK (auth.uid() = user_id);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can update own notes' AND tablename = 'notes') THEN
    CREATE POLICY "Users can update own notes" ON public.notes FOR UPDATE USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can delete own notes' AND tablename = 'notes') THEN
    CREATE POLICY "Users can delete own notes" ON public.notes FOR DELETE USING (auth.uid() = user_id);
  END IF;
END $$;

-- TRAINING COMPLETIONS RLS
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can manage own training' AND tablename = 'training_completions') THEN
    CREATE POLICY "Users can manage own training" ON public.training_completions FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
  END IF;
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Supervisors can read clinic training' AND tablename = 'training_completions') THEN
    CREATE POLICY "Supervisors can read clinic training" ON public.training_completions FOR SELECT USING (EXISTS (SELECT 1 FROM public.profiles AS supervisor WHERE supervisor.id = auth.uid() AND supervisor.role IN ('supervisor', 'dev') AND supervisor.clinic_id IS NOT NULL AND supervisor.clinic_id = (SELECT p.clinic_id FROM public.profiles AS p WHERE p.id = training_completions.user_id)));
  END IF;
END $$;

-- SYNC QUEUE RLS
DO $$ BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_policies WHERE policyname = 'Users can manage own sync queue' AND tablename = 'sync_queue') THEN
    CREATE POLICY "Users can manage own sync queue" ON public.sync_queue FOR ALL USING (auth.uid() = user_id) WITH CHECK (auth.uid() = user_id);
  END IF;
END $$;
`;

document.getElementById('sql-preview').textContent = MIGRATION_SQL;

function copySQL() {
  navigator.clipboard.writeText(MIGRATION_SQL).then(() => {
    const btn = document.getElementById('copy-btn');
    btn.textContent = 'Copied!';
    btn.style.background = '#22c55e';
    setTimeout(() => { btn.textContent = 'Copy Migration SQL'; btn.style.background = ''; }, 2000);
  });
}

function toggleSQL() {
  const el = document.getElementById('sql-preview');
  el.classList.toggle('hidden');
}

async function checkTable(name) {
  try {
    const res = await fetch(SUPABASE_URL + '/rest/v1/' + name + '?select=*&limit=0', {
      headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
    });
    return { name, exists: res.status === 200, status: res.status };
  } catch (e) {
    return { name, exists: false, error: e.message };
  }
}

async function verifySchema() {
  const btn = document.getElementById('verify-btn');
  const loading = document.getElementById('verify-loading');
  const results = document.getElementById('verify-results');

  btn.disabled = true;
  loading.classList.remove('hidden');
  results.style.display = 'none';

  const tables = ['profiles', 'clinics', 'notes', 'training_completions', 'sync_queue'];
  const checks = await Promise.all(tables.map(checkTable));

  loading.classList.add('hidden');
  btn.disabled = false;

  const allOk = checks.every(c => c.exists);
  let html = '';

  if (allOk) {
    html += '<div class="status status-ok">All 5 tables verified successfully!</div>';
  } else {
    const missing = checks.filter(c => !c.exists).length;
    html += '<div class="status status-err">' + missing + ' table(s) missing. Please run the migration SQL in the Supabase SQL Editor.</div>';
  }

  html += '<div class="table-grid">';
  for (const c of checks) {
    html += '<div class="table-row">';
    html += '<span class="table-icon">' + (c.exists ? '✅' : '❌') + '</span>';
    html += '<span class="table-name">' + c.name + '</span>';
    html += '<span class="table-status">' + (c.exists ? 'OK' : 'Missing') + '</span>';
    html += '</div>';
  }
  html += '</div>';

  if (allOk) {
    html += '<div class="status status-info" style="margin-top:1rem;">Schema is ready! You can now use the app at <a href="/test2/">http://localhost:5173/test2/</a></div>';
  }

  results.innerHTML = html;
  results.style.display = 'block';
}

// Auto-verify on page load
verifySchema();
</script>
</body>
</html>
