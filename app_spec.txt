<project_specification>
  <project_name>PackageBackEnd</project_name>

  <overview>
    A Progressive Web Application for medical triage documentation and training validation based on ADTMC MEDCOM PAM 40-7-21. The app enables medics to navigate triage algorithms, document decisions, generate and share notes via PDF417 barcodes, and track training completion. Built offline-first with service worker caching and Supabase backend for sync, targeting ~50 users initially with enterprise scalability in mind.
  </overview>

  <technology_stack>
    <frontend>
      <framework>React with TypeScript</framework>
      <bundler>Vite</bundler>
      <styling>Tailwind CSS</styling>
      <pwa>Service Worker with Cache-first strategy, Web App Manifest</pwa>
      <offline_storage>Cache API, IndexedDB for note persistence and sync queue</offline_storage>
    </frontend>
    <backend>
      <provider>Supabase</provider>
      <database>PostgreSQL (Supabase-hosted)</database>
      <auth>Supabase Auth</auth>
      <api>Supabase Client SDK (auto-generated REST API + Realtime)</api>
      <edge_functions>Supabase Edge Functions (as needed)</edge_functions>
    </backend>
    <communication>
      <api>Supabase JS Client (REST under the hood)</api>
      <offline_sync>Custom sync queue — IndexedDB queues mutations, pushes on reconnect</offline_sync>
    </communication>
    <security>
      <api_keys>All API keys stored in environment variables (.env), never committed to source control. Supabase anon key used client-side with Row Level Security (RLS) enforcing access. Service role key server-side only (Edge Functions).</api_keys>
      <rls>Row Level Security enabled on all tables. Policies enforce user and clinic-scoped data access.</rls>
      <env_files>.env files added to .gitignore. Example .env.example provided with placeholder values.</env_files>
    </security>
    <future>
      <packaging>Cross-platform packaging (PakePlus-style) with SW-based OTA update delivery</packaging>
      <enterprise>Role-based access control, clinic management, supervisor dashboards</enterprise>
    </future>
  </technology_stack>

  <prerequisites>
    <environment_setup>
      - Node.js 18+
      - npm or pnpm
      - Supabase project (cloud or local via supabase CLI)
      - Environment variables: VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY
      - .env file (not committed) with Supabase credentials
    </environment_setup>
  </prerequisites>

  <feature_count>84</feature_count>

  <constraints>
    <do_not_modify>
      - Existing UI components, animations, or functionality unless specifically instructed
      - Algorithm, medication, or training data — content is verbatim from ADTMC MEDCOM PAM 40-7-21
      - Existing buttons and processes unless cleaning code
    </do_not_modify>
    <do_not_perform>
      - Build or deploy — handled by the project owner
      - Edit static reference data
    </do_not_perform>
    <allowed>
      - Code cleanup when touching existing processes
      - Adding Supabase infrastructure alongside existing functionality
      - Fixing or rewriting service worker and cache logic
    </allowed>
  </constraints>

  <security_and_access_control>
    <user_roles>
      <role name="medic">
        <permissions>
          - Can view all algorithm categories, subcategories, and flows
          - Can create, view, edit, delete own notes
          - Can import notes via PDF417 or encoded string
          - Can export/share notes via PDF417, encoded string, or copy
          - Can view medication information
          - Can complete training items
          - Can search algorithms, medications, training
          - Can toggle theme
        </permissions>
      </role>
      <role name="supervisor">
        <permissions>
          - All medic permissions
          - Can view training completion status of medics in their clinic (future)
          - Can validate training completion for other users (future)
        </permissions>
      </role>
      <role name="dev">
        <permissions>
          - All supervisor permissions
          - Full administrative access (future)
        </permissions>
      </role>
    </user_roles>
    <authentication>
      <method>Supabase Auth (email/password initially)</method>
      <session_timeout>Managed by Supabase Auth session tokens</session_timeout>
      <offline_auth>Cached auth state allows offline usage after initial login</offline_auth>
    </authentication>
    <sensitive_operations>
      - API keys protected via environment variables and RLS
      - No PII/PHI stored in notes
      - Note data: timestamp, user info (display name, rank, UIC), algorithm reference, HPI encoded text
    </sensitive_operations>
  </security_and_access_control>

  <core_features>
    <infrastructure>
      - Database connection established (Supabase PostgreSQL)
      - Database schema applied correctly
      - Data persists across server restart
      - No mock data patterns in codebase
      - Backend API queries real database
    </infrastructure>

    <auth_and_user_management>
      - User registration via Supabase Auth
      - User login via Supabase Auth
      - User logout
      - User profile storage (display name, rank, UIC)
      - Offline auth state caching
      - Session persistence across app restarts
      - Clinic association derived from UIC
      - Role schema (dev, supervisor, medic) in database
    </auth_and_user_management>

    <main_algorithm_view>
      - Display ADTMC MEDCOM PAM 40-7-21 categories (verbatim)
      - Display subcategories for selected category
      - Desktop: show symptom information and algorithm flow side by side
      - Mobile: show algorithm flow with symptom info as drawer
      - Step-by-step algorithm flow navigation
      - Algorithm state tracking during navigation
      - Scroll position retention
      - Responsive layout switching (desktop/mobile)
      - Static bundled data rendering (no edits to data)
      - Cache busted on app update when PAM is revised
    </main_algorithm_view>

    <notes_write>
      - View decision-making summary from algorithm
      - Customize note input fields
      - Copy note to clipboard
      - Copy encoded string to clipboard
      - Share/generate PDF417 barcode
      - Save note to local cache (IndexedDB)
      - Automatic timestamp generation
      - User info attachment (display name, rank, UIC)
      - Algorithm reference attachment
      - HPI encoded text field
      - Edit existing saved note
      - Delete saved note
    </notes_write>

    <notes_import>
      - Import PDF417 via device camera
      - Import PDF417 via file system
      - Import via encoded string input
      - Decode and display imported note
      - Save imported note to local cache
      - Malformed barcode/string error handling
    </notes_import>

    <notes_list_manage>
      - Sorted list view of saved notes
      - Select note to view details
      - Select note to edit
      - Select note to delete
      - Share/copy note from list
      - Empty state when no notes exist
    </notes_list_manage>

    <drawers_and_navigation>
      - Desktop menu navigation
      - Mobile drawer navigation
      - Gesture support for mobile drawers
      - Medications drawer
      - Settings drawer
      - Symptom info drawer (mobile)
      - WriteNotePage drawer
      - ImportNote drawer
    </drawers_and_navigation>

    <offline_and_sync>
      - Service worker registration and activation
      - Cache-first strategy for static assets and data
      - Full offline functionality (all features work offline)
      - Sync created notes to Supabase on reconnect
      - Sync updated notes to Supabase on reconnect
      - Sync deleted notes to Supabase on reconnect
      - Conflict resolution by most recent timestamp
      - Cache busting on app update
      - Web App Manifest configuration
      - Connectivity detection and sync queue management
    </offline_and_sync>

    <training>
      - Training content display in settings
      - Scroll-through training items (separate from algorithm)
      - Per-item completion flag
      - Completion state persistence (local + Supabase sync)
      - Training completion syncs to Supabase
    </training>

    <settings>
      - Access to saved notes list
      - Light/dark theme toggle
      - Theme preference persistence
      - Training section access
    </settings>

    <medications>
      - Medication list display
      - Medication detail view
      - Offline availability of medication data
    </medications>

    <search>
      - Unified search across algorithms, medications, and training
      - Search results display
      - Navigation to selected search result
      - Search works offline
    </search>

    <service_worker_verification>
      - SW registers and activates correctly
      - Cached resources available when offline
      - Cache busting works on app update
    </service_worker_verification>
  </core_features>

  <database_schema>
    <tables>
      <profiles>
        - id (uuid, references auth.users)
        - display_name (text)
        - rank (text)
        - uic (text)
        - role (text: 'medic' | 'supervisor' | 'dev', default 'medic')
        - clinic_id (uuid, references clinics, nullable)
        - created_at (timestamptz)
        - updated_at (timestamptz)
      </profiles>
      <clinics>
        - id (uuid, primary key)
        - name (text)
        - uic (text, unique)
        - created_at (timestamptz)
        - updated_at (timestamptz)
      </clinics>
      <notes>
        - id (uuid, primary key)
        - user_id (uuid, references profiles)
        - clinic_id (uuid, references clinics, nullable)
        - timestamp (timestamptz)
        - display_name (text)
        - rank (text)
        - uic (text)
        - algorithm_reference (text)
        - hpi_encoded (text)
        - is_imported (boolean, default false)
        - source_device (text, nullable)
        - created_at (timestamptz)
        - updated_at (timestamptz)
        - deleted_at (timestamptz, nullable, soft delete)
      </notes>
      <training_completions>
        - id (uuid, primary key)
        - user_id (uuid, references profiles)
        - training_item_id (text)
        - completed (boolean, default false)
        - completed_at (timestamptz, nullable)
        - created_at (timestamptz)
        - updated_at (timestamptz)
      </training_completions>
      <sync_queue>
        - id (uuid, primary key)
        - user_id (uuid, references profiles)
        - action (text: 'create' | 'update' | 'delete')
        - table_name (text)
        - record_id (uuid)
        - payload (jsonb)
        - created_at (timestamptz)
        - synced_at (timestamptz, nullable)
        - status (text: 'pending' | 'synced' | 'failed')
      </sync_queue>
    </tables>
    <rls_policies>
      - profiles: Users can read/update own profile. Supervisors can read profiles in their clinic.
      - clinics: Authenticated users can read clinics. Dev role can create/update.
      - notes: Users can CRUD own notes. Users can read notes in their clinic.
      - training_completions: Users can CRUD own completions. Supervisors can read completions in their clinic.
      - sync_queue: Users can only access own sync records.
    </rls_policies>
  </database_schema>

  <api_endpoints_summary>
    <auth>
      - POST /auth/v1/signup (Supabase Auth)
      - POST /auth/v1/token?grant_type=password (Supabase Auth)
      - POST /auth/v1/logout (Supabase Auth)
    </auth>
    <profiles>
      - GET /rest/v1/profiles?id=eq.{user_id} (get own profile)
      - PATCH /rest/v1/profiles?id=eq.{user_id} (update own profile)
    </profiles>
    <clinics>
      - GET /rest/v1/clinics (list clinics)
      - GET /rest/v1/clinics?uic=eq.{uic} (get clinic by UIC)
    </clinics>
    <notes>
      - GET /rest/v1/notes?user_id=eq.{user_id} (list own notes)
      - GET /rest/v1/notes?clinic_id=eq.{clinic_id} (list clinic notes)
      - POST /rest/v1/notes (create note)
      - PATCH /rest/v1/notes?id=eq.{id} (update note)
      - PATCH /rest/v1/notes?id=eq.{id} (soft delete — set deleted_at)
    </notes>
    <training>
      - GET /rest/v1/training_completions?user_id=eq.{user_id} (list own completions)
      - POST /rest/v1/training_completions (create completion)
      - PATCH /rest/v1/training_completions?id=eq.{id} (update completion)
    </training>
  </api_endpoints_summary>

  <ui_layout>
    <main_structure>
      Existing PWA layout — do not modify unless specifically instructed.
      - Main component page with category/subcategory navigation
      - Desktop: side-by-side symptom info + algorithm flow
      - Mobile: algorithm flow with symptom info drawer
      - Drawer-based navigation for Medications, Settings, WriteNote, ImportNote
      - Mobile drawers with gesture support
      - Existing color scheme and icons — do not change
    </main_structure>
    <responsive>
      - Desktop: full layout with visible menu
      - Mobile: drawer-based navigation with gesture support
    </responsive>
  </ui_layout>

  <design_system>
    <color_palette>
      Existing color scheme — do not modify. Already provided in codebase.
    </color_palette>
    <typography>
      Existing typography — do not modify. Already provided in codebase.
    </typography>
    <theme>
      Light/dark mode toggle. Existing theme implementation.
    </theme>
  </design_system>

  <implementation_steps>
    <step number="1">
      <title>Supabase Infrastructure Setup</title>
      <tasks>
        - Configure Supabase project connection
        - Set up environment variables (.env with VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY)
        - Create .env.example with placeholder values
        - Add .env to .gitignore
        - Initialize Supabase client with proper key management
        - Create database schema (profiles, clinics, notes, training_completions, sync_queue)
        - Configure Row Level Security policies on all tables
        - Verify database connectivity and schema
      </tasks>
    </step>
    <step number="2">
      <title>Authentication</title>
      <tasks>
        - Implement Supabase Auth (signup, login, logout)
        - Create user profile management (display name, rank, UIC)
        - Implement offline auth state caching
        - Auto-associate clinic based on UIC
        - Set up role field in profiles (default: medic)
      </tasks>
    </step>
    <step number="3">
      <title>Service Worker Fix and Offline Infrastructure</title>
      <tasks>
        - Fix existing service worker registration and activation issues
        - Implement proper cache-first strategy
        - Fix cache busting mechanism
        - Implement connectivity detection
        - Set up IndexedDB for local note storage
        - Implement sync queue (IndexedDB-based) for offline mutations
        - Ensure all features work fully offline
      </tasks>
    </step>
    <step number="4">
      <title>Notes — Supabase Integration</title>
      <tasks>
        - Connect note create/update/delete to Supabase
        - Implement sync-on-reconnect for notes (create, update, delete)
        - Implement conflict resolution by most recent timestamp
        - Associate notes with user and clinic
        - Maintain existing note functionality (PDF417, copy, encode, import)
      </tasks>
    </step>
    <step number="5">
      <title>Training — Supabase Integration</title>
      <tasks>
        - Connect training completion tracking to Supabase
        - Sync completion state on reconnect
        - Persist completion state locally for offline use
      </tasks>
    </step>
    <step number="6">
      <title>Verification and Hardening</title>
      <tasks>
        - Verify full offline functionality (all features)
        - Verify sync queue processes correctly on reconnect
        - Verify RLS policies block unauthorized access
        - Verify no API keys exposed in client bundle beyond anon key
        - Verify cache busting works on app update
        - Verify conflict resolution works correctly
        - Production-readiness review
      </tasks>
    </step>
  </implementation_steps>

  <success_criteria>
    <functionality>
      - All existing PWA features continue to work without regression
      - Supabase auth works (register, login, logout)
      - Notes sync to Supabase and are scoped by user and clinic
      - Training completion syncs to Supabase
      - Full offline functionality — every feature works without connectivity
      - Sync-on-reconnect processes all queued changes
      - Conflict resolution by timestamp works correctly
    </functionality>
    <user_experience>
      - No perceptible change to existing UI/UX unless specifically instructed
      - Seamless offline-to-online transition
      - No data loss during connectivity changes
    </user_experience>
    <technical_quality>
      - Production-ready code quality
      - API keys properly secured (env vars, .gitignore, RLS)
      - Row Level Security enforced on all Supabase tables
      - Service worker registers, activates, and caches correctly
      - Cache busting works on app updates
      - No mock data patterns in codebase
      - Clean, maintainable TypeScript
    </technical_quality>
    <design_polish>
      - Existing design preserved — no changes to color scheme, icons, layout, animations
      - Light/dark theme continues to work
    </design_polish>
  </success_criteria>
</project_specification>
