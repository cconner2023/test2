================================================================================
PROJECT REFACTORING PROGRESS LOG
================================================================================
Started: 2026-02-02
Goal: Fix layout navigation and simplify code
Constraint: Do NOT modify data structures (they are verbatim from external sources)


================================================================================
EXPLORATION PHASE - COMPLETED
================================================================================

CODEBASE STRUCTURE:
- 14 Components (NavTop, CategoryList, AlgorithmPage, MedicationPage, etc.)
- 6 Hooks (useNavigation, useSearch, useAlgorithm, useNoteCapture, etc.)
- 3 Data files (CatData, MedData, Algorithms) - DO NOT MODIFY
- 2 Type files (CatTypes, AlgorithmTypes)


================================================================================
DESIGN IMPROVEMENTS - SESSION 2026-02-02
================================================================================

TASK 1: IMPROVE DRAWER ANIMATIONS (Settings & SymptomInfoDrawer)
✓ Settings.tsx:
  - Fixed bottom glitch: Changed height from 99vh to 92vh
  - Added backdrop with opacity animation
  - Changed transform from vh to % for smoother animation
  - Increased transition duration to 300ms for iOS-like feel
  - Updated border radius and shadow for native iOS appearance
  - Improved swipe gesture handling

✓ SymptomInfoDrawer.tsx:
  - Added full swipe gesture support (touch/mouse)
  - Implemented velocity-based momentum closing
  - Added backdrop with animated opacity
  - Changed to 92vh height to match Settings
  - Added smooth cubic easing for iOS-like animations
  - Implemented position-based animation system

TASK 2: USER INFORMATION IN SETTINGS
✓ Added user profile section in Settings.tsx:
  - Displays below header, above settings options
  - Components: User icon (circular avatar), name, subtitle
  - Right-aligned chevron button for navigation
  - Styled with hover/active states
  - Ready for backend integration (currently shows "Guest User")
  - Responsive design for mobile/desktop

TASK 3: IMPROVE CATEGORYLIST
✓ Updated icon styling:
  - Changed from rounded-full to rounded-md (badge style)
  - Matches AlgorithmPage badge design
  - Applied to: categories, symptoms, and symptom header
  - Changed from w-10/h-10 circular to px-3/py-2 badge with font-bold

✓ Reorganized training guidelines:
  - DDX: Already in "Differentials" section (no change needed)
  - Separated training into distinct sections:
    * "MEDCOM Training" (selectedSymptom.medcom)
    * "STP Training" (selectedSymptom.stp)
    * "General Guidelines" (selectedSymptom.gen)
  - Each section has its own header and only shows if data exists

FILES MODIFIED:
- src/Components/Settings.tsx
- src/Components/SymptomInfoDrawer.tsx
- src/Components/CategoryList.tsx

NOTES:
- All changes maintain existing data structures (no data file modifications)
- Drawer animations now feel native iOS-like with smooth gestures
- User section is placeholder-ready for authentication implementation
- CategoryList visual hierarchy improved with badge-style icons


================================================================================
MOBILE NAVTOP IMPROVEMENTS - SESSION 2026-02-02
================================================================================

TASK 1: INCREASE BUTTON SIZES FOR iOS CONSISTENCY
✓ Updated mobile button sizes:
  - Changed from w-8 h-8 (32px) to w-11 h-11 (44px)
  - Matches iOS standard tap target size (44x44pt)
  - Applied to: Back button, Menu button, Search button, Info button
  - Improves touch accuracy and feels more native on iOS

TASK 2: SHOW INFO BUTTON ONLY ON ALGORITHMPAGE
✓ Added isAlgorithmView prop to UIState interface
✓ Updated App.tsx to pass navigation.showQuestionCard as isAlgorithmView
✓ Changed Info button visibility logic:
  - Old: shouldShowInfoWithSearch = showBack && showDynamicTitle && !isSearchExpanded
  - New: shouldShowInfoButton = isAlgorithmView && !isSearchExpanded
  - Info button now only appears when viewing AlgorithmPage
  - Provides contextual help only when relevant

TASK 3: WIDEN CONTAINER FOR BETTER MOBILE FEEL
✓ Updated right button container:
  - Increased padding from p-0.5 to p-1 for better spacing
  - Container width dynamically adjusts based on button visibility
  - Info button: animates from w-0 to w-11 when appearing
  - Creates more natural, spacious feel on mobile devices

TASK 4: ADD FADE-IN TRANSITIONS
✓ Enhanced button appearance animations:
  - Info button: transition-all duration-300 with opacity fade
  - Search button: transition-all duration-200
  - Back/Menu buttons: transition-all duration-200
  - Smooth fade-in/out when buttons appear/disappear
  - Uses overflow-hidden on Info wrapper for clean animation

FILES MODIFIED:
- src/Types/NavTopTypes.ts (added isAlgorithmView to UIState)
- src/App.tsx (pass showQuestionCard as isAlgorithmView)
- src/Components/NavTop.tsx (button sizes, visibility logic, transitions)

TECHNICAL NOTES:
- Button sizes now meet iOS Human Interface Guidelines (44x44pt minimum)
- All transitions use ease-out for natural iOS-like deceleration
- Container border provides unified appearance for button group
- Info button width animation prevents layout shift


================================================================================
NAVTOP ALIGNMENT & CENTERING - SESSION 2026-02-02
================================================================================

TASK 1: ALIGN PADDING WITH CATEGORYLIST
✓ Updated NavTop horizontal padding:
  - Changed from px-3 to px-2
  - Now matches CategoryList item padding (px-2)
  - Creates visual alignment between navbar and content
  - Menu/Back buttons line up with list items below

TASK 2: CENTER TITLE ON MOBILE
✓ Repositioned title for better mobile layout:
  - Title now uses flex-1 for proper centering between left and right sections
  - Three-column layout: Left (buttons) | Center (title) | Right (search)
  - Title hidden on desktop (desktop shows: buttons | search | settings)
  - Maintains fade-out when search expands on mobile
  - Text-center alignment for perfect visual balance

TASK 3: RESTRUCTURE MOBILE LAYOUT
✓ Reorganized NavTop for clearer mobile structure:
  - Left section (shrink-0): Home/Back button only
  - Center section (flex-1): Title with center alignment
  - Right section (shrink-0): Info + Search button container
  - Desktop maintains separate layout (buttons | search | settings)
  - Responsive flex properties for optimal spacing

FILES MODIFIED:
- src/Components/NavTop.tsx

VISUAL IMPROVEMENTS:
- Mobile navbar now has consistent px-2 padding throughout app
- Title perfectly centered using flexbox (not absolute positioning)
- Clear three-column mobile layout: button | title | search
- Back/Menu buttons align with content items below
- Professional, cohesive appearance across all views


================================================================================
NOTE CAPTURE/IMPORT STRATEGY + WRITENOTEPAGE REFACTOR - SESSION 2026-02-02
================================================================================

TASK 1: FIX BARCODE ENCODING/DECODING ROUNDTRIP (useNoteCapture ↔ useNoteImport)

PROBLEM IDENTIFIED:
- Old encoding only captured last visible card (lost full algorithm path)
- HPI text was never encoded in barcode
- includeDecisionMaking flag was not encoded
- Answer index searched questionOptions instead of answerOptions (bug)
- useNoteImport assumed all intermediate cards answered "No" (incorrect)
- Decision Making content was never reconstructed on import

SOLUTION - NEW ENCODING FORMAT:
  {symptomCode}|R{rfBase36}|{idx}.{selBase36}.{ansIdx}|...|H{base64Hpi}|F{flagsDigit}

  - A{code}: Symptom/algorithm code (e.g. A1)
  - R{base36}: Red flag selections as bitmask in base36
  - {idx}.{sel}.{ans}: For EACH visible non-RF card:
    * idx = card index (decimal)
    * sel = selection bitmask in base36 (0 if none)
    * ans = answer index from answerOptions (-1 if no answer)
  - H{base64}: HPI text encoded as btoa(encodeURIComponent(text))
  - F{digit}: Flags byte (bit0=algo, bit1=DM, bit2=HPI)

  Example: A1|R1k|1.0.0|3.0.1|5.3.0|HSGVsbG8=|F7

✓ Barcode.tsx:
  - Rewrote generateCompactString() with new encoding format
  - Now encodes ALL visible card states (not just last card)
  - Added includeDecisionMaking to NoteBarcodeOptions interface
  - Fixed answer index to search answerOptions (was questionOptions - BUG FIX)
  - Added HPI base64 encoding (btoa + encodeURIComponent for Unicode safety)
  - Added flags byte encoding

✓ useNoteImport.ts:
  - Complete rewrite of importFromBarcode() decoding
  - Parses new format: card entries, HPI, flags
  - Legacy format backward compatibility (L/S parts still work)
  - generateAlgorithmContent(): Reconstructs algorithm section matching useNoteCapture
  - generateDecisionMakingContent(): Reconstructs DM section with proper disposition lookup
    * Finds current disposition from card entries
    * Matches decisionMaking items using same logic as DecisionMaking component
    * Includes DDx, text, ancillary findings, limitations, associated MCP
  - Full note output matches useNoteCapture.generateNote() format:
    * HPI section (if flagged)
    * SCREENED IAW timestamp
    * Algorithm section (if flagged)
    * DECISION MAKING section (if flagged)

TASK 2: FIX ALGORITHPAGE HARDCODED SELECTEDSYMPTOM
✓ AlgorithmPage.tsx:
  - Changed hardcoded selectedSymptom={{ icon: 'A-1', text: 'Sore Throat/Hoarseness' }}
  - Now passes actual selectedSymptom from props: {{ icon: selectedSymptom?.icon, text: selectedSymptom?.text }}
  - Barcode symptomCode now derived correctly: selectedSymptom.icon.replace('-','')

TASK 3: REFACTOR WRITENOTEPAGE WITH SWIPE GESTURES

✓ WriteNotePage.tsx - Complete refactor:

  HORIZONTAL SWIPE (page navigation):
  - Two swipeable pages: Decision Making (page 0) ↔ Write Note (page 1)
  - Touch gesture with direction disambiguation (|dx| > |dy| = horizontal)
  - Velocity-based snap (threshold 0.3 px/ms) or position-based (20% of width)
  - Edge resistance (0.25x) when swiping past first/last page
  - Smooth cubic-bezier transition (300ms) on snap
  - Page indicator tabs in header (tappable + shows active underline)
  - touch-action: pan-y on content allows vertical scroll within pages

  SWIPE-DOWN-TO-CLOSE (mobile bottom sheet):
  - Drag handle at top of sheet (mobile only)
  - Header also draggable for larger touch target
  - Velocity-based close (threshold 0.4 px/ms) or position-based (>35%)
  - Sheet slides from translateY(100%) to translateY(0%) on mount (300ms)
  - Animated backdrop with dynamic opacity (0 to 0.4)
  - touch-action: none on drag handle/header for full gesture control

  BOTTOM SHEET BEHAVIOR (mobile):
  - 95vh height, rounded-t-2xl corners, box-shadow
  - Backdrop click to close
  - Smooth cubic-bezier transitions with willChange optimization
  - Algorithm view stays mounted behind sheet (visible through backdrop)

  DESKTOP BEHAVIOR:
  - No swipe gestures (click tabs + close button)
  - Fills container normally (no bottom sheet)
  - Same page navigation via tab clicks

  BARCODE INTEGRATION:
  - Passes includeDecisionMaking to NoteBarcodeGenerator
  - Passes correct symptomCode from selectedSymptom.icon
  - Full note content (algo + DM + HPI) encoded in barcode

✓ AlgorithmPage.tsx - Animation update:
  - Algorithm view stays mounted when note-expanded on mobile
  - Note view has z-10 overlay for proper stacking
  - Enables backdrop peek-through on mobile bottom sheet

FILES MODIFIED:
- src/Components/Barcode.tsx (encoding rewrite)
- src/Hooks/useNoteImport.ts (decoding rewrite)
- src/Components/WriteNotePage.tsx (full refactor)
- src/Components/AlgorithmPage.tsx (selectedSymptom fix + animation)

BUILD STATUS: ✓ TypeScript passes, Vite build succeeds

NEXT STEPS FOR FUTURE CONTEXT:
- Test full encode/decode roundtrip with actual algorithm data
- Consider QR code option alongside PDF417 for shorter encoded strings
- Test swipe gestures on physical iOS/Android devices
- Consider adding haptic feedback on swipe snap
- May want to add page dots indicator below header for visual affordance
- NoteImport.tsx could benefit from camera barcode scanning integration

